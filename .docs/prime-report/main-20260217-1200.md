# Prime Report: main branch
**Date:** 2026-02-17 12:00
**Branch:** main

---

## Project Overview

- **Purpose:** BeKesher ("In Touch") is a networking platform for new immigrants in Israel, connecting people through weekly gamified meetups within 4-week seasons
- **Type:** Full-stack web application (monorepo) with Convex serverless backend, Telegram Mini App (user-facing), and Admin Dashboard
- **Current state:** Post-MVP with seasons + tasks/missions feature just merged (PR #42: `masha/season-flow`). Core functionality is operational: registration, matching, payments, feedback, support, and now seasons with task assignments
- **Target audience:** Russian-speaking new immigrants (olim) in Israel, ages 18-65

---

## Architecture

### Overall Structure

**Monorepo** using npm workspaces with three main areas:

```
bekesher/
├── convex/                # Serverless backend (Convex functions)
│   ├── schema.ts          # 10 tables: participants, groups, seasons, tasks, taskAssignments, seasonParticipants, feedback, paymentLogs, supportTickets, sessions
│   ├── validators.ts      # Centralized Convex v.union() validators + TS type exports
│   ├── authAdmin.ts       # Admin auth (Google OIDC + email allowlist)
│   ├── authUser.ts        # User auth (Telegram HMAC-SHA256 + session bypass)
│   ├── participants.ts    # User registration/profile (Lead → Active → Inactive)
│   ├── matching.ts        # 5-stage weekly matching algorithm (with seasons)
│   ├── groups.ts          # Group lifecycle (Active → Completed/Cancelled)
│   ├── seasons.ts         # Season CRUD (Draft → Active → Completed)
│   ├── seasonParticipants.ts # Season enrollment management
│   ├── tasks.ts           # Task CRUD (Activity/Conversation/Creative/Philosophy)
│   ├── taskAssignments.ts # Task assignment + completion + review workflow
│   ├── feedback.ts        # Post-meetup feedback (+10 points)
│   ├── payments.ts        # PayPlus integration
│   ├── notifications.ts   # Telegram Bot API messaging
│   ├── crons.ts           # Scheduled jobs (Saturday matching cycle)
│   ├── http.ts            # Webhooks (PayPlus, Telegram, bypass auth, health)
│   ├── i18n.ts            # Backend i18n (JSON-based, ru/en)
│   ├── utils.ts           # calculateAge, getSundayRevealTimeIsrael, calculateWeekInSeason
│   ├── seed.ts            # Database seeding
│   └── test.utils.ts      # Test factories (makeParticipant, makeGroup, etc.)
├── apps/
│   ├── user/              # Telegram Mini App (React + Vite, port 5173)
│   └── admin/             # Admin Dashboard (React + Vite, port 5174)
├── legacy/                # Reference files from old system (Airtable, Make.com, Google Script)
├── .docs/                 # Documentation, brainstorming, plans, prime reports
└── .github/workflows/     # CI/CD (deploy.yml, deploy-convex-only.yml)
```

### Key Architectural Patterns

- **Domain-driven file organization** — Each backend domain (participants, groups, matching, etc.) is a single file with queries, mutations, and internal functions
- **Custom auth wrappers** — `userQuery`/`userMutation` (Telegram token HMAC validation), `adminQuery`/`adminMutation` (Google OIDC + email allowlist), `publicMutation` (unauthenticated)
- **Event-driven real-time** — Convex provides automatic real-time subscriptions; frontend uses `useQuery`/`useMutation` hooks
- **Staged matching algorithm** — 5 stages (A→E) progressively relax constraints: region → age range → repeat history → neighboring regions → force majeure
- **Season-scoped matching** — Matching only runs within active season for enrolled participants

---

## Sub-System Deep Dives

### `convex/` — Backend Logic Hub (21 source files + 8 test files)

**Architecture:** Flat, domain-driven. Each file = one business domain.

**Auth System (dual-track):**
- **User auth** (`authUser.ts`): Telegram `initData` HMAC-SHA256 validation OR session token bypass (for CI/CD/AI/dev). Injects `ctx.telegramId`
- **Admin auth** (`authAdmin.ts`): Google OIDC via `@react-oauth/google`. Hardcoded email allowlist (4 emails). Injects `ctx.adminEmail`
- **Session bypass**: HTTP endpoint `/auth/bypass-session` creates temporary tokens with `AUTH_BYPASS_SECRET`

**Weekly Cycle (Season-aware):**
1. **Saturday 18:00** — Cron `weeklyCloseAndMatch` runs:
   - Step 1: Close active groups → mark incomplete tasks as "NotCompleted"
   - Step 2: Run matching for enrolled+active+not-paused participants in active season
   - Groups created with `seasonId`, `weekInSeason`, `taskId: undefined`
2. **Saturday 18:00 - Sunday 8:00** — Admin manually assigns tasks to groups
3. **Sunday 8:00** — Tasks become visible to participants (reveal time calculated by `getSundayRevealTimeIsrael()`)
4. **During week** — Participants complete tasks, submit reports with photos
5. **Admin reviews** — Approve/Revision/Reject with points (5 text / 10 photos)

**Data Model (10 tables):**
- `participants` — Core user profiles with status, points, subscription tracking
- `participantChangeLogs` — Audit trail for profile field changes
- `seasons` — 4-week season containers (Draft → Active → Completed)
- `seasonParticipants` — Enrollment tracking (Enrolled/Paused/Completed/Dropped)
- `groups` — Weekly matched groups (2-4 people) with season context
- `tasks` — Reusable task templates (type, difficulty, purpose)
- `taskAssignments` — Per-group task lifecycle (Pending → Approved/Rejected/NotCompleted)
- `feedback` — Post-meetup ratings and comments
- `paymentLogs` — PayPlus transaction records
- `supportTickets` — User support Q&A
- `sessions` — Auth bypass tokens for dev/CI/CD

**State Machines:**
- Participant: `Lead → Active → Inactive` (with `onPause` toggle)
- Season: `Draft → Active → Completed`
- Season Participant: `Enrolled → Paused/Completed/Dropped`
- Group: `Active → Completed/Cancelled`
- Task Assignment: `Pending → Approved/Revision/Rejected/NotCompleted`

### `apps/user/` — Telegram Mini App

**Architecture:** Page-based React SPA with protected routes.

**Pages:** HomePage, OnboardingPage, ProfilePage, GroupsPage, TaskPage, FeedbackPage, SupportPage

**Key Components:**
- `ProtectedRoute` — Requires authenticated participant
- `UserHeader`/`UserFooter` — Navigation chrome
- `CollapsibleProfileCard` — Expandable profile display
- `useTelegramAuth` hook — Extracts Telegram WebApp initData
- `useLanguage` hook — Language detection and persistence

**Auth flow:** Telegram WebApp SDK provides `initData` → passed as `telegramToken` arg to every Convex query/mutation

**i18n:** `@lingui/react` with Russian and English PO files

### `apps/admin/` — Admin Dashboard

**Architecture:** Sidebar navigation + page-based layout with AuthGuard.

**Pages:** DashboardPage, ParticipantsPage, GroupsPage, SeasonsPage, TasksPage, AssignmentsPage, ReviewPage, FeedbackPage, SupportPage, MatchingPage

**Key Components:**
- `Sidebar` — Main navigation
- `LoginPage` — Google OAuth login
- `AuthGuard` — Requires Convex auth
- `useAdminAuth` hook — Google OIDC integration
- `LanguageSwitcher` — Toggle ru/en

**Auth flow:** Google OAuth → Convex Auth → `adminQuery`/`adminMutation` validates email against allowlist

---

## Tech Stack

### Languages & Versions
- **TypeScript** 5.x (strict throughout)
- **Node.js** 18+

### Frameworks & Libraries
- **Convex** 1.17.0 — Backend-as-a-Service (database, functions, scheduling, file storage)
- **React** 18.2 — UI framework
- **Vite** 5.x — Build tool and dev server
- **React Router** 6.22 — Client-side routing
- **@lingui/react** 5.9 + `@lingui/core` — i18n (frontend)
- **@react-oauth/google** 0.13 — Google OAuth (admin app only)
- **convex-helpers** 0.1.112 — Custom function wrappers
- **lucide-react** 0.564 — Icons (user app only)

### Build & Package Management
- **npm workspaces** — Monorepo management
- **Vite** — Frontend builds
- **ESLint** 8.57 — Linting (--max-warnings 0)

### Testing
- **Vitest** 3.0 — Test runner
- **convex-test** 0.0.34 — Convex function testing
- **@edge-runtime/vm** 4.0 — Edge runtime for tests
- 8 test files covering all backend domains

### Deployment
- **Convex Cloud** — Backend hosting
- **Netlify** — Frontend hosting (both apps)
- **GitHub Actions** — CI/CD (deploy.yml, deploy-convex-only.yml)

### External Services
- **Telegram Bot API** — Notifications, channel management
- **Telegram Web App SDK** — User auth, Mini App integration
- **PayPlus** — Israeli payment processing
- **Google OAuth** — Admin authentication
- **ngrok** — Dev tunneling for Telegram webhook testing

---

## Core Principles

### Code Style & Conventions
- Domain-per-file organization in `convex/`
- Centralized validators in `validators.ts` with exported TypeScript types
- Custom auth wrappers (`userQuery`, `adminQuery`, `publicMutation`) enforce auth at the function level
- Database indexes follow `by_field` or `by_field1_and_field2` naming
- Explicit return type validators on all Convex functions
- Emoji-free code (emojis only in console.log for dev visibility)

### Documentation Standards
- Comprehensive CLAUDE.md with commands, architecture overview, conventions
- Full PRD in `.docs/PRD.md`
- Detailed brand design system in `.docs/styleguide.md`
- Brainstorming docs with decisions timeline in `.docs/brainstorming/`
- Implementation plans in `.docs/plans/`
- Prime reports in `.docs/prime-report/`

### Testing Approach
- Backend-focused testing with `vitest` + `convex-test`
- Colocated test files (`*.test.ts` next to source)
- Factory functions in `test.utils.ts` (makeParticipant, makeGroup, etc.)
- Coverage across all domains: participants, groups, matching, feedback, payments, support, tasks, crons, http

---

## Current State

### Active Branch
- **main** (up to date with origin)

### Recent Changes
- **PR #42 merged** (`masha/season-flow`): Major feature — Seasons + Tasks integration
  - New tables: `seasons`, `seasonParticipants`, `tasks`, `taskAssignments`
  - Matching algorithm updated to be season-aware
  - Cron schedule changed: Sunday → Saturday 18:00
  - Task assignment + completion + admin review workflow
  - Admin pages: SeasonsPage, TasksPage, AssignmentsPage, ReviewPage
  - User page: TaskPage
- Recent commits: bugfixes, cleanup, backend tests

### Uncommitted Changes
- Modified: `convex/_generated/api.d.ts` (auto-generated, likely from local `npx convex dev`)

### Key Decisions Timeline (from brainstorming docs)
1. **2026-02-16**: Tasks/Missions system decided — **Option B** (Tasks as Group Assignments) selected
   - Separate task completion from feedback
   - Admin review required for task completion
   - Points: +5 text, +10 photos (after admin approval)
2. **2026-02-16**: Seasons + Tasks integration finalized
   - Seasons are 4 weeks, manually activated by admin
   - Matching runs Saturday 18:00 (changed from Sunday)
   - Tasks assigned manually by admin after matching
   - Task reveal: Sunday 8:00 AM Israel time
   - Mid-season joins not allowed in MVP
   - Season enrollment tracked via `seasonParticipants` table

### Observations
- The `notifications.ts` has TODO comments — notification logic is partially stubbed (welcome, group match, feedback request messages exist but some use `@ts-expect-error` for internal references)
- `cleanupOldData` cron handler is a TODO stub
- Some webhook handlers (Telegram bot commands) are partially stubbed
- The `i18n.ts` backend module uses `require()` which may not work in all Convex runtime environments
- No end-to-end or integration tests for frontend apps
- The `.playwright-mcp/` directory contains console logs from browser testing sessions
